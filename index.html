<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generator</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load new QR Code library: qr-code-styling (Trying jsdelivr CDN instead of cdnjs) -->
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.6.0/lib/qr-code-styling.min.js"></script>
    <style>
        /* Custom styles for the QR code container */
        #qrcode canvas {
            margin: auto; /* Center the generated canvas */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen font-sans py-12">

    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
            QR Code Generator
        </h1>

        <!-- Input field -->
        <div class="mb-4">
            <label for="text-input" class="block text-sm font-medium text-gray-700 mb-2">
                Enter text or URL
            </label>
            <textarea
                id="text-input"
                rows="4"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                placeholder="e.g., https://www.google.com"
            ></textarea>
        </div>

        <!-- New: Logo Upload -->
        <div class="mb-4">
            <label for="logo-input" class="block text-sm font-medium text-gray-700 mb-2">
                Upload Logo (Optional)
            </label>
            <input
                type="file"
                id="logo-input"
                accept="image/*"
                class="w-full text-sm text-gray-500
                       file:mr-4 file:py-2 file:px-4
                       file:rounded-lg file:border-0
                       file:text-sm file:font-semibold
                       file:bg-blue-50 file:text-blue-700
                       hover:file:bg-blue-100"
            />
        </div>

        <!-- Error message box -->
        <div id="error-box" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4" role="alert">
            <span class="block sm:inline" id="error-message"></span>
        </div>

        <!-- Generate Button -->
        <button id="generate-btn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-200">
            Generate QR Code
        </button>

        <!-- QR Code Display Area -->
        <div 
            id="qrcode-container" 
            class="mt-6 border-2 border-dashed border-gray-300 rounded-lg min-h-[280px] w-[280px] mx-auto p-4 flex items-center justify-center"
        >
            <!-- The qr-code-styling library will target the div below -->
            <div id="qrcode"></div>
            <span id="placeholder-text" class="text-gray-400 text-center">
                Your QR code will appear here
            </span>
        </div>

        <!-- Download Button (hidden initially) -->
        <button id="download-btn" class="hidden w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-200 mt-4">
            Download QR Code
        </button>
    </div>

    <script>
        // Wait for the entire window to load, including external scripts
        window.onload = () => {
            // Get DOM elements
            const generateBtn = document.getElementById('generate-btn');
            const downloadBtn = document.getElementById('download-btn');
            const textInput = document.getElementById('text-input');
            const logoInput = document.getElementById('logo-input');
            const qrcodeDiv = document.getElementById('qrcode');
            const placeholderText = document.getElementById('placeholder-text');
            const errorBox = document.getElementById('error-box');
            const errorMessage = document.getElementById('error-message');

            let qrCodeInstance = null; // This will hold the QRCodeStyling instance

            // Function to show an error message
            function showError(message) {
                errorMessage.textContent = message;
                errorBox.classList.remove('hidden');
            }

            // Function to hide the error message
            function hideError() {
                errorBox.classList.add('hidden');
            }

            // Helper function to append QR code and show download button
            function appendAndShowDownload() {
                try {
                    // Append the QR code (as a canvas) to our div
                    qrCodeInstance.append(qrcodeDiv);
                    // Show the download button
                    downloadBtn.classList.remove('hidden');
                } catch (error) {
                    console.error('QR Code generation failed:', error);
                    showError('An error occurred while generating the QR code.');
                    placeholderText.classList.remove('hidden');
                }
            }

            // Generate QR Code
            generateBtn.addEventListener('click', () => {
                const text = textInput.value.trim();
                const logoFile = logoInput.files[0];

                // Clear previous QR code and hide download button
                qrcodeDiv.innerHTML = '';
                downloadBtn.classList.add('hidden');
                hideError();

                if (!text) {
                    showError('Please enter some text or a URL.');
                    placeholderText.classList.remove('hidden');
                    return;
                }

                // Hide placeholder
                placeholderText.classList.add('hidden');

                // --- Base options for the new library ---
                const options = {
                    width: 256,
                    height: 256,
                    data: text,
                    margin: 0,
                    qrOptions: {
                        typeNumber: 0,
                        mode: 'Byte',
                        errorCorrectionLevel: 'H' // High correction level, good for logos
                    },
                    dotsOptions: {
                        color: '#000000',
                        type: 'rounded'
                    },
                    backgroundOptions: {
                        color: '#ffffff',
                    },
                    imageOptions: {
                        crossOrigin: 'anonymous',
                        margin: 4,      // Margin around the logo
                        imageSize: 0.4, // Logo size (40% of QR code)
                        hideBackgroundDots: true // Hides dots behind the logo
                    }
                };

                // Create the QR code instance
                // This line was causing the error, it should now be fixed
                // by loading the script correctly.
                try {
                    // Check if QRCodeStyling is available before using it
                    if (typeof QRCodeStyling === 'undefined') {
                        showError("QR code library failed to load. Please check your internet connection and refresh.");
                        console.error("QRCodeStyling is not defined. Library might not have loaded.");
                        placeholderText.classList.remove('hidden');
                        return;
                    }
                    qrCodeInstance = new QRCodeStyling(options);
                } catch (e) {
                    console.error("Failed to initialize QRCodeStyling:", e);
                    showError("Failed to load QR code library. Please refresh the page.");
                    placeholderText.classList.remove('hidden');
                    return;
                }
                
                if (logoFile) {
                    // If a logo is selected, we need to read it as a Data URL
                    const reader = new FileReader();
                    reader.onload = () => {
                        // Update the instance with the logo image data
                        qrCodeInstance.update({
                            image: reader.result
                        });
                        // Now generate and show the QR code
                        appendAndShowDownload();
                    };
                    reader.onerror = () => {
                        showError('Failed to read logo file.');
                        placeholderText.classList.remove('hidden');
                    };
                    reader.readAsDataURL(logoFile);
                } else {
                    // No logo, just generate the code immediately
                    appendAndShowDownload();
                }
            });

            // Download QR Code (much simpler with this library)
            downloadBtn.addEventListener('click', () => {
                if (!qrCodeInstance) {
                    showError('No QR code instance found to download.');
                    return;
                }

                // The library has its own download method
                qrCodeInstance.download({
                    name: 'qrcode-with-logo',
                    extension: 'png'
                });
            });
        };
    </script>

</body>
</html>

